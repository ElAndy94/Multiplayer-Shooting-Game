<div id="signDiv">   <!-- Signing in Div -->
    Username: <input id="signDiv-username" type="text"></input><br>  <!--input username box -->
    Password: <input id="signDiv-password" type="password"></input> <!--input password box -->
    <button id="signDiv-signIn">Sign In</button> <!-- Sign in button -->
    <button id="signDiv-signUp">Sign Up</button> <!-- Sign UP in button -->
</div>
<script src="/socket.io/socket.io.js"></script>
<body onload="loadSound();">

  <div id="gameDiv" style="display:none;">   <!-- Game Div, display none, until logged in! -->
      <canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"> <!-- creating canvas -->
      </canvas> 

  </div>
    </body>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"> <!--Mobile functionality -->
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script> <!--Mobile functionality -->
    <script src="https://code.createjs.com/soundjs-0.6.2.min.js"></script>
    <!-- <script src="scriptDraw.js"></script> -->

<script>
    var socket = io(); // socket io
    var WIDTH = 500;
    var HEIGHT = 500;
    var soundID = "Shot"; //sound

    //signIn/Out
    var signDiv = document.getElementById('signDiv'); //<!-- Sign in Div -->
    var signDivUsername = document.getElementById('signDiv-username'); //<!-- username element -->
    var signDivSignIn = document.getElementById('signDiv-signIn'); //<!-- sign in element -->
    var signDivPassword = document.getElementById('signDiv-password'); //<!-- password element -->
    var signDivUp = document.getElementById('signDiv-signUp'); //<!-- password element -->


    signDivSignIn.onclick = function(){  //<!-- clicking the sign in button does this function -->
        socket.emit('LogIn',{username:signDivUsername.value,password:signDivPassword.value}); //<!-- emits username + password to server -->
        }

    signDivUp.onclick = function(){  //<!-- clicking the sign in button does this function -->
        socket.emit('signUp',{username:signDivUsername.value,password:signDivPassword.value}); //<!-- emits username + password to server -->
        }

    socket.on('LogInResponse',function(data){  // Sign in Response function
        if(data.success){
            signDiv.style.display = 'none'; //display none until the logging has been passed
            gameDiv.style.display = 'inline-block'; //when log in has been passed then it will display the gameDiv
        }  else
            alert("Sign in was unsuccessful!"); //if password or username is wrong, you get this alart
    });

    socket.on('signPlayerRes',function(data){  // Sign UP*** in Response function
        if(data.success){
            alert("Sign up was successful!");
        }  else
            alert("Sign in was unsuccessful!"); // Not signing up
    });


    //game

function loadSound () {
    createjs.Sound.registerSound("/client/shot.mp3", soundID); //gets the sound from my client file named shot.mp3
    }

function playSound () { //play sound function
    createjs.Sound.play(soundID);
    }

var ctx = document.getElementById('ctx').getContext('2d');
 ctx.font = '30px Arial';

var Img = {}; //creats image array
    Img.bullet = new Image(); 
    Img.bullet.src = '/client/images/bullet.png'; //loads the bullet
    Img.player = new Image(); 
    Img.player.src = '/client/images/littleman.png'; //loads the player
    Img.grass = new Image(); 
    Img.grass.src = '/client/images/target.png'; //loads the background
    Img.grass = new Image(); 
    Img.grass.src = '/client/images/grasses.png'; //loads the background

    var Player = function(infoPack){
        var self = {};
        self.id = infoPack.id; //id
        self.number = infoPack.number; //number
        self.x = infoPack.x;  // self.x location
        self.y = infoPack.y; // self.y location
        self.healthPoints = infoPack.healthPoints; //health Points
        self.maxHealthPoints = infoPack.maxHealthPoints; //health max = at 10
        self.score = infoPack.score;  //the score of the player
        
        self.draw = function(){	
            var x = self.x - Player.list[selfId].x + WIDTH/2;
            var y = self.y - Player.list[selfId].y + WIDTH/2;

            var hpWidth = 30 * self.healthPoints / self.maxHealthPoints; //draws the health bar
            ctx.fillStyle = 'red'; //red health bar
            ctx.fillRect(x - hpWidth/2,y - 40,hpWidth,4); //at the position it draws it
            
            var width = Img.player.width/25;  //the width of the player img /25 because it was too big
            var height = Img.player.width/25; //the height of the player img /25 because it was too big

            ctx.drawImage(Img.player,  //draws the image here.
            0,0,Img.player.width,Img.player.height,
            x-width/2,y-height/2,width,height);
        }
        
        Player.list[self.id] = self;
        
        return self;
    }
    Player.list = {};

        
    var Bullet = function(infoPack){
        var self = {};
        self.id = infoPack.id;
        self.x = infoPack.x; //bullet x
        self.y = infoPack.y; //bullet y
        self.draw = function(){
            var width = Img.bullet.width/10; //bullet width size
            var height = Img.bullet.width/10; //bullet height size

            var x = self.x - Player.list[selfId].x + WIDTH/2;
            var y = self.y - Player.list[selfId].y + WIDTH/2;

            ctx.drawImage(Img.bullet,0,0,Img.bullet.width,Img.bullet.height,
            x-width/2,y-height/2,width,height);
        }
        
        Bullet.list[self.id] = self;		
        return self;
    }
    Bullet.list = {};


    var Target = function(infoPack){
        var self = {};
        self.id = infoPack.id; //target id
        self.x = infoPack.x; //target x
        self.y = infoPack.y; //target y
        
        console.log(self.x + "x");
        console.log(self.y + "y");
        console.log('hey');

        self.draw = function(){
            var width = Img.target.width/10; //bullet width size
            var height = Img.target.width/10; //bullet height size

            var x = self.x - Player.list[selfId].x + WIDTH/2;
            var y = self.y - Player.list[selfId].y + WIDTH/2;

            ctx.drawImage(Img.target,0,0,Img.target.width,Img.target.height,
            x-width/2,y-height/2,width,height);
        }
        console.log('do you see me');
        Target.list[self.id] = self;		
        return self;
    }
    Target.list = {};
    
    var selfId = null;

    Player.list[selfId];

    //player and bullet info big pack
socket.on('starterPack',function(data){
    if(data.selfId)
        selfId = data.selfId;

    for(var i = 0; i < data.player.length; i++) //player
        new Player(data.player[i]);

    for(var i = 0; i < data.bullet.length; i++) //bullet
        new Bullet(data.bullet[i]);

    for(var i = 0; i < data.target.length; i++) //target
        new Target(data.target[i]);
    });

    
socket.on('update',function(data){ // update player and bullet location - id
    for(var i = 0; i < data.player.length; i++){
        var pack = data.player[i];
        var ple = Player.list[pack.id];
        if(ple) {
                if(pack.x !== undefined)
                ple.x = pack.x;
                if(pack.y !== undefined)
                ple.y = pack.y;
                if(pack.heatlhPoints !== undefined)
                ple.healthPoints = pack.healthPoints;
                if(pack.score !== undefined)
                ple.score = pack.score;
        }
    }

    for(var i = 0; i < data.bullet.length; i++){
        var pack = data.bullet[i];
        var bul = Bullet.list[data.bullet[i].id];
        if(bul) {
                if(pack.x !== undefined)
                bul.x = pack.x;
                if(pack.y !== undefined)
                bul.y = pack.y;
        }
    }

    for(var i = 0; i < data.target.length; i++){
        var pack = data.target[i];
        var tar = Target.list[data.target[i].id];
        if(tar) {
                if(pack.x !== undefined)
                tar.x = pack.x;
                if(pack.y !== undefined)
                tar.y = pack.y;
        }
    }
    });

    //remove player/bullet
socket.on('remove',function(data){
    for(var i = 0; i < data.player.length; i++){ //removing player
        delete Player.list[data.player[i]];
    }
    for(var i = 0; i < data.bullet.length; i++){ //removing bullet
        delete Bullet.list[data.bullet[i]];
    }
    for(var i = 0; i < data.target.length; i++){ //removing target
        delete Target.list[data.target[i]];
    }
    });

    //draw
setInterval(function(){
    if(!selfId) //if player isnt set then dont draw anything, helps us with not getting the errors!*
        return;             //if player logs on then the below will work.

        ctx.clearRect(0,0,500,500);
        drawGrass(); //draws my map
        theScore();  //draws the score
        for(var i in Player.list)  //draws the playlist every set miliseconds
            Player.list[i].draw();
        for(var i in Bullet.list) //draws the bulletlist every set miliseconds
            Bullet.list[i].draw();
        for(var i in Target.list) //draws the targetlist every set miliseconds
            Target.list[i].draw();
            console.log(Target.list[i]);
    },40);

var theScore = function(){
    ctx.fillStyle = 'black'; //score on black text
    ctx.fillText(Player.list[selfId].score,0,30); //draws the score for THAT player only!**
    }

var drawGrass = function(){
    var x = WIDTH/2 - Player.list[selfId].x; //makes the character always on the middle of the map, which fixes the shots problem.
    var y = WIDTH/2 - Player.list[selfId].y; //same as above.
    ctx.drawImage(Img.grass,x,y); //draw grass function
        // ctx.drawImage(Img.grass,1,1,500,500); //draws the grass in that area
    }

document.onkeydown = function(event){ //keyboard controls
        if(event.keyCode === 39) //right arrow
            socket.emit('movementKey' ,{inputId:'right',state:true});
        if(event.keyCode === 40) //down arrow
            socket.emit('movementKey' ,{inputId:'down',state:true});
        if(event.keyCode === 37) //left arrow
            socket.emit('movementKey' ,{inputId:'left',state:true});
        if(event.keyCode === 38) //up arrow
            socket.emit('movementKey' ,{inputId:'up',state:true});
        }

document.onkeyup = function(event){
        if(event.keyCode === 39) //right arrow
            socket.emit('movementKey' ,{inputId:'right',state:false});
        if(event.keyCode === 40) //down arrow
            socket.emit('movementKey' ,{inputId:'down',state:false});
        if(event.keyCode === 37) //left arrow
            socket.emit('movementKey' ,{inputId:'left',state:false});
        if(event.keyCode === 38) //up arrow
            socket.emit('movementKey' ,{inputId:'up',state:false});
        }

document.onmousedown = function(event){
    socket.emit('movementKey',{inputId:'attack',state:true}); //mouse down to attack (click)*

if(event.target.attributes["id"].value !== "ctx"){ // only plays shot sound once im logged in, had clickdown sound when pressing login!*
        return;
    } else {
        playSound(); //plays the shot sound
    }
    }

document.onmouseup = function(event){
    socket.emit('movementKey',{inputId:'attack',state:false}); //when not attacking, (unlicked)*
    }

document.onmousemove = function(event){
    var x = -250 + event.clientX - 8;  //500 being the whole screen
    var y = -250 + event.clientY - 8;
    var angle = Math.atan2(y,x) / Math.PI * 180;
    socket.emit('movementKey',{inputId:'mouseAngle',state:angle});
    }

  </script>
